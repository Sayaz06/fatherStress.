<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FatherStress</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png" />
  <style>
    body { margin:0; font-family:sans-serif; background:#0f172a; color:#f8fafc; }
    .hidden { display:none }
    .appbar { display:flex; align-items:center; gap:8px; background:#111827; padding:10px; color:#fff }
    .container { padding:16px; max-width:960px; margin:auto }
    button { padding:8px 12px; border-radius:6px; border:1px solid #333; background:#222; color:#fff; cursor:pointer }
    .list { display:grid; gap:8px; margin-top:12px }
    .row { display:flex; justify-content:space-between; align-items:center; background:#1f2937; padding:8px; border-radius:6px }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
    .editor { min-height:200px; background:#0a1220; padding:10px; border-radius:6px }
  </style>
</head>
<body>
  <!-- Appbar -->
  <div class="appbar">
    <button id="backButton" class="hidden">Kembali</button>
    <div>FatherStress</div>
    <div style="flex:1"></div>
    <div id="userEmail"></div>
  </div>

  <div class="container">
    <!-- Login Page -->
    <section id="page-login">
      <h2>Login</h2>
      <button id="googleLoginBtn">Login dengan Google</button>
    </section>

    <!-- Home Page -->
    <section id="page-home" class="hidden">
      <h2>Senarai Tajuk</h2>
      <button id="logoutBtn">Logout</button>
      <div>
        <input id="topicSearch" placeholder="Cari tajuk">
        <button id="addTopicBtn">Tambah Tajuk Baharu</button>
      </div>
      <div id="topicsList" class="list"></div>
    </section>

    <!-- Folder Page -->
    <section id="page-folders" class="hidden">
      <h2 id="foldersTitle">Folder</h2>
      <div>
        <input id="folderSearch" placeholder="Cari folder">
        <button id="addFolderBtn">Tambah Folder Baharu</button>
      </div>
      <div id="foldersList" class="list"></div>
    </section>

    <!-- Note Page -->
    <section id="page-notes" class="hidden">
      <h2 id="notesTitle">Nota</h2>
      <div class="toolbar">
        <button data-cmd="bold">Bold</button>
        <button data-cmd="underline">Underline</button>
        <input id="colorInput" type="color" value="#ffffff">
        <select id="fontSizeSelect"></select>
      </div>
      <div id="noteEditor" class="editor" contenteditable="true"></div>
      <p id="saveStatus">Auto-save aktif.</p>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const current = { user:null, topicId:null, folderId:null, noteDocId:'main' };

    // Navigasi ringkas
    function navigate(hash){
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
      if(hash.startsWith('#home')) document.getElementById('page-home').classList.remove('hidden');
      else if(hash.startsWith('#folders')) document.getElementById('page-folders').classList.remove('hidden');
      else if(hash.startsWith('#notes')) document.getElementById('page-notes').classList.remove('hidden');
      else document.getElementById('page-login').classList.remove('hidden');
    }
    window.addEventListener('hashchange',()=>navigate(location.hash));

    // Auth state
    auth.onAuthStateChanged(user=>{
      current.user=user;
      document.getElementById('userEmail').textContent=user?user.email:'';
      if(user){ location.hash='#home'; navigate('#home'); renderTopics(); } 
      else { location.hash='#login'; navigate('#login'); }
    });

    // Login/Logout
    document.getElementById('googleLoginBtn').onclick=async()=>{
      const provider=new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    };
    document.getElementById('logoutBtn').onclick=()=>auth.signOut();

    // Back button
    document.getElementById('backButton').onclick=()=>{
      if(location.hash.startsWith('#notes')) location.hash=`#folders/${current.topicId}`;
      else if(location.hash.startsWith('#folders')) location.hash='#home';
    };

    // Util search
    function matchesQuery(text,q){ return !q || text.toLowerCase().includes(q.toLowerCase()); }

    // Topics CRUD
    const topicsCol=()=>db.collection('users').doc(current.user.uid).collection('topics');

    async function renderTopics(){
      const snap=await topicsCol().get();
      const list=document.getElementById('topicsList'); 
      list.innerHTML='';
      const q=document.getElementById('topicSearch').value;

      snap.forEach(doc=>{
        const d=doc.data();
        if(matchesQuery(d.title||'',q)){
          const row=document.createElement('div'); 
          row.className='row';
          row.innerHTML=`<div>${d.title}</div>
            <div>
              <button data-open="${doc.id}">Buka</button>
              <button data-edit="${doc.id}">Sunting</button>
              <button data-del="${doc.id}">Padam</button>
            </div>`;
          list.appendChild(row);
        }
      });

      // Event listeners
      list.querySelectorAll('[data-open]').forEach(btn=>{
        btn.onclick=()=>{location.hash=`#folders/${btn.dataset.open}`;}
      });

      list.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick=async()=>{
          const id=btn.dataset.edit; 
          const doc=await topicsCol().doc(id).get();
          const title=prompt('Sunting tajuk:',doc.data().title||'');
          if(title&&title.trim()!==''){ 
            await topicsCol().doc(id).update({title,updatedAt:Date.now()}); 
            renderTopics(); 
          }
        }
      });

      list.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick=async()=>{
          if(confirm('Padam tajuk?')){ 
            await topicsCol().doc(btn.dataset.del).delete(); 
            renderTopics(); 
          }
        }
      });
    }

    document.getElementById('addTopicBtn').onclick=async()=>{
      const title=prompt('Masukkan tajuk baharu:');
      if(title){ 
        await topicsCol().add({title,createdAt:Date.now()}); 
        renderTopics(); 
      }
    };

    document.getElementById('topicSearch').oninput=renderTopics;

    // Folders CRUD
    const foldersCol=(tid)=>topicsCol().doc(tid).collection('folders');
    async function renderFolders(tid){
      current.topicId=tid;
      const snap=await foldersCol(tid).get();
      const list=document.getElementById('foldersList'); list.innerHTML='';
      const q=document.getElementById('folderSearch').value;
      snap.forEach(doc=>{
        const d=doc.data();
        if(matchesQuery(d.title||'',q)){
          const row=document.createElement('div'); row.className='row';
          row.innerHTML=`<div>${d.title}</div>
            <div>
              <button data-open="${doc.id}">Buka</button>
              <button data-edit="${doc.id}">Sunting</button>
              <button data-del="${doc.id}">Padam</button>
            </div>`;
          list.appendChild(row);
        }
      });
      list.querySelectorAll('[data-open]').forEach(btn=>btn.onclick=()=>{location.hash=`#notes/${tid}/${btn.dataset.open}`;});
      list.querySelectorAll('[data-edit]').forEach(btn=>btn.onclick=async()=>{
        const id=btn.dataset.edit; const doc=await foldersCol(tid).doc(id).get();
        const title=prompt('Sunting folder:',doc.data().title||'');
        if(title&&title.trim()!==''){ await foldersCol(tid).doc(id).update({title,updatedAt:Date.now()}); renderFolders(tid); }
      });
      list.querySelectorAll('[data-del]').forEach(btn=>btn.onclick=async()=>{
        if(confirm('Padam folder?')){ await foldersCol(tid).doc(btn.dataset.del).delete(); renderFolders(tid); }
      });
    }
    document.getElementById('addFolderBtn').onclick=async()=>{
      const title=prompt('Masukkan folder baharu:');
      if(title){ await foldersCol(current.topicId).add({title,createdAt:Date.now()}); renderFolders(current.topicId); }
    };
    document.getElementById('folderSearch').oninput=()=>renderFolders(current.topicId);

    // Notes
    const noteDoc=(tid,fid,nid='main')=>foldersCol(tid).doc(fid).collection('notes').doc(nid);

    // Populate font size options
    (()=>{ const sel=document.getElementById('fontSizeSelect'); for(let i=1;i<=60;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i+'pt'; sel.appendChild(opt);} })();

    // Toolbar actions
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.onclick=()=>{ document.execCommand(btn.dataset.cmd,false,null); noteChanged(); };
    });
    document.getElementById('colorInput').oninput=e=>{ document.execCommand('foreColor',false,e.target.value); noteChanged(); };
    document.getElementById('fontSizeSelect').onchange=e=>{
      const sizePt=e.target.value+'pt';
      const sel=window.getSelection(); 
      if(sel.rangeCount){ 
        const range=sel.getRangeAt(0); 
        const span=document.createElement('span'); 
        span.style.fontSize=sizePt; 
        range.surroundContents(span); 
      }
      noteChanged();
    };

    // Autosave
    const editor=document.getElementById('noteEditor');
    const saveStatus=document.getElementById('saveStatus');
    let saveTimer=null;
    function noteChanged(){ 
      clearTimeout(saveTimer); 
      saveStatus.textContent='Menyimpan...'; 
      saveTimer=setTimeout(saveNote,800); 
    }
    editor.oninput=noteChanged;

    async function openNote(tid,fid){
      current.folderId=fid; current.noteDocId='main';
      document.getElementById('notesTitle').textContent='Nota â€” '+fid;
      editor.innerHTML=''; saveStatus.textContent='Auto-save aktif.';
      const doc=await noteDoc(tid,fid,current.noteDocId).get();
      if(doc.exists){ editor.innerHTML=doc.data().content||''; }
      else { await noteDoc(tid,fid,current.noteDocId).set({content:'',createdAt:Date.now()}); }
    }
    async function saveNote(){
      if(!current.user||!current.topicId||!current.folderId) return;
      const html=editor.innerHTML;
      try{ 
        await noteDoc(current.topicId,current.folderId,current.noteDocId).set({content:html,updatedAt:Date.now()},{merge:true});
        saveStatus.textContent='Disimpan automatik.'; 
      }
      catch(e){ 
        saveStatus.textContent='Simpan gagal.'; 
        console.error(e); 
      }
    }

    // Service worker register
    if('serviceWorker' in navigator){ 
      window.addEventListener('load',()=>{ navigator.serviceWorker.register('service-worker.js'); }); 
    }
  </script>
</body>
</html>
